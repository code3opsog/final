{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/stashy/Desktop/Projects/Trend/src/lib/supabase.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\nconst supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\r\n\r\nexport const supabase = createClient(supabaseUrl, supabaseKey);\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AACN,MAAM;AAEC,MAAM,WAAW,IAAA,gMAAY,EAAC,aAAa"}},
    {"offset": {"line": 59, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/stashy/Desktop/Projects/Trend/src/lib/auth.ts"],"sourcesContent":["import { SignJWT, jwtVerify } from 'jose';\r\nimport { cookies } from 'next/headers';\r\nimport { supabase } from './supabase';\r\n\r\nconst JWT_SECRET = new TextEncoder().encode(process.env.JWT_SECRET || 'fallback-secret');\r\n\r\nexport interface JWTPayload {\r\n    userId: string;\r\n    discordId: string;\r\n    isAdmin: boolean;\r\n}\r\n\r\nexport async function createSession(userId: string, discordId: string, isAdmin: boolean, ip?: string, userAgent?: string) {\r\n    const token = await new SignJWT({ userId, discordId, isAdmin })\r\n        .setProtectedHeader({ alg: 'HS256' })\r\n        .setExpirationTime('7d')\r\n        .sign(JWT_SECRET);\r\n\r\n    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString();\r\n\r\n    await supabase.from('sessions').insert({\r\n        user_id: userId,\r\n        token,\r\n        ip,\r\n        user_agent: userAgent,\r\n        expires_at: expiresAt,\r\n    });\r\n\r\n    return token;\r\n}\r\n\r\nexport async function verifySession(token: string): Promise<JWTPayload | null> {\r\n    try {\r\n        const { payload } = await jwtVerify(token, JWT_SECRET);\r\n\r\n        console.log('verifySession - JWT payload:', payload);\r\n\r\n        // Simple query without join\r\n        const { data: session, error: sessionError } = await supabase\r\n            .from('sessions')\r\n            .select('*')\r\n            .eq('token', token)\r\n            .single();\r\n\r\n        if (sessionError) {\r\n            console.error('verifySession - Session query error:', sessionError);\r\n            return null;\r\n        }\r\n\r\n        if (!session || new Date(session.expires_at) < new Date()) {\r\n            console.log('verifySession - Session expired or not found');\r\n            return null;\r\n        }\r\n\r\n        // Get user separately\r\n        const { data: user, error: userError } = await supabase\r\n            .from('users')\r\n            .select('*')\r\n            .eq('id', session.user_id)\r\n            .single();\r\n\r\n        if (userError || !user) {\r\n            console.error('verifySession - User query error:', userError);\r\n            return null;\r\n        }\r\n\r\n        console.log('verifySession - Success, user:', user.username);\r\n\r\n        return {\r\n            userId: session.user_id,\r\n            discordId: user.discord_id,\r\n            isAdmin: user.is_admin,\r\n        };\r\n    } catch (error) {\r\n        console.error('verifySession - JWT or other error:', error);\r\n        return null;\r\n    }\r\n}\r\n\r\nexport async function getCurrentUser() {\r\n    const cookieStore = await cookies();\r\n    const token = cookieStore.get('session')?.value;\r\n\r\n    if (!token) return null;\r\n\r\n    const payload = await verifySession(token);\r\n    if (!payload) return null;\r\n\r\n    const { data: user } = await supabase\r\n        .from('users')\r\n        .select('*')\r\n        .eq('id', payload.userId)\r\n        .single();\r\n\r\n    return user;\r\n}\r\n\r\nexport async function isUserAuthorized(userId: string): Promise<boolean> {\r\n    const { data: user } = await supabase\r\n        .from('users')\r\n        .select('*')\r\n        .eq('id', userId)\r\n        .single();\r\n\r\n    if (!user) return false;\r\n    if (user.is_admin) return true;\r\n    if (!user.is_authorized) return false;\r\n    if (user.auth_expiry && new Date(user.auth_expiry) < new Date()) return false;\r\n\r\n    return true;\r\n}\r\n\r\nexport function getDiscordOAuthUrl() {\r\n    const params = new URLSearchParams({\r\n        client_id: process.env.DISCORD_CLIENT_ID!,\r\n        redirect_uri: process.env.DISCORD_REDIRECT_URI!,\r\n        response_type: 'code',\r\n        scope: 'identify email',\r\n    });\r\n\r\n    return `https://discord.com/api/oauth2/authorize?${params.toString()}`;\r\n}\r\n\r\nexport async function exchangeCodeForToken(code: string) {\r\n    const response = await fetch('https://discord.com/api/oauth2/token', {\r\n        method: 'POST',\r\n        headers: {\r\n            'Content-Type': 'application/x-www-form-urlencoded',\r\n        },\r\n        body: new URLSearchParams({\r\n            client_id: process.env.DISCORD_CLIENT_ID!,\r\n            client_secret: process.env.DISCORD_CLIENT_SECRET!,\r\n            grant_type: 'authorization_code',\r\n            code,\r\n            redirect_uri: process.env.DISCORD_REDIRECT_URI!,\r\n        }),\r\n    });\r\n\r\n    return response.json();\r\n}\r\n\r\nexport async function getDiscordUser(accessToken: string) {\r\n    const response = await fetch('https://discord.com/api/users/@me', {\r\n        headers: {\r\n            Authorization: `Bearer ${accessToken}`,\r\n        },\r\n    });\r\n\r\n    return response.json();\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 186, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/stashy/Desktop/Projects/Trend/src/app/api/auth/discord/callback/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { exchangeCodeForToken, getDiscordUser, createSession } from '@/lib/auth';\r\nimport { supabase } from '@/lib/supabase';\r\nimport { headers } from 'next/headers';\r\n\r\n// Get the app URL from environment, fallback to request.url for local dev\r\nfunction getAppUrl(requestUrl: string): string {\r\n    return process.env.NEXT_PUBLIC_APP_URL || requestUrl;\r\n}\r\n\r\nexport async function GET(request: NextRequest) {\r\n    const searchParams = request.nextUrl.searchParams;\r\n    const code = searchParams.get('code');\r\n    const baseUrl = getAppUrl(request.url);\r\n\r\n    if (!code) {\r\n        return NextResponse.redirect(new URL('/?error=no_code', baseUrl));\r\n    }\r\n\r\n    try {\r\n        // Exchange code for token\r\n        const tokenData = await exchangeCodeForToken(code);\r\n\r\n        console.log('Discord token response:', JSON.stringify(tokenData, null, 2));\r\n\r\n        if (tokenData.error) {\r\n            console.error('Token exchange error:', tokenData.error, tokenData.error_description);\r\n            return NextResponse.redirect(new URL(`/?error=token_exchange&desc=${encodeURIComponent(tokenData.error_description || tokenData.error)}`, baseUrl));\r\n        }\r\n\r\n        // Get Discord user info\r\n        const discordUser = await getDiscordUser(tokenData.access_token);\r\n\r\n        if (!discordUser.id) {\r\n            return NextResponse.redirect(new URL('/?error=user_fetch', baseUrl));\r\n        }\r\n\r\n        // Check if user is the admin\r\n        const isAdmin = discordUser.id === process.env.ADMIN_DISCORD_ID;\r\n\r\n        // Check if user exists\r\n        const { data: existingUser } = await supabase\r\n            .from('users')\r\n            .select('*')\r\n            .eq('discord_id', discordUser.id)\r\n            .single();\r\n\r\n        let user;\r\n\r\n        if (existingUser) {\r\n            // Update existing user\r\n            const { data: updatedUser } = await supabase\r\n                .from('users')\r\n                .update({\r\n                    username: discordUser.username,\r\n                    email: discordUser.email,\r\n                    avatar: discordUser.avatar,\r\n                    is_admin: isAdmin || existingUser.is_admin,\r\n                    updated_at: new Date().toISOString(),\r\n                })\r\n                .eq('discord_id', discordUser.id)\r\n                .select()\r\n                .single();\r\n            user = updatedUser;\r\n        } else {\r\n            // Create new user\r\n            const { data: newUser } = await supabase\r\n                .from('users')\r\n                .insert({\r\n                    discord_id: discordUser.id,\r\n                    username: discordUser.username,\r\n                    email: discordUser.email,\r\n                    avatar: discordUser.avatar,\r\n                    is_admin: isAdmin,\r\n                    is_authorized: isAdmin, // Admin is auto-authorized\r\n                })\r\n                .select()\r\n                .single();\r\n            user = newUser;\r\n        }\r\n\r\n        if (!user) {\r\n            return NextResponse.redirect(new URL('/?error=user_create', baseUrl));\r\n        }\r\n\r\n        // Get IP and User Agent\r\n        const headersList = await headers();\r\n        const ip = headersList.get('x-forwarded-for') || headersList.get('x-real-ip') || 'unknown';\r\n        const userAgent = headersList.get('user-agent') || 'unknown';\r\n\r\n        // Create session\r\n        const sessionToken = await createSession(user.id, user.discord_id, user.is_admin, ip, userAgent);\r\n\r\n        // Set cookie and redirect\r\n        const response = NextResponse.redirect(new URL('/dashboard', baseUrl));\r\n        response.cookies.set('session', sessionToken, {\r\n            httpOnly: true,\r\n            secure: process.env.NODE_ENV === 'production',\r\n            sameSite: 'lax',\r\n            maxAge: 7 * 24 * 60 * 60, // 7 days\r\n            path: '/',\r\n        });\r\n\r\n        return response;\r\n    } catch (error) {\r\n        console.error('OAuth callback error:', error);\r\n        return NextResponse.redirect(new URL('/?error=callback_error', baseUrl));\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}